---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: dkube-controller-worker
    ksonnet.io/component: dkube
  name: dkube-controller-worker-verTag
  namespace: dkube
spec:
  selector:
    matchLabels:
      app: dkube-controller-worker
  template:
    metadata:
      labels:
        app: dkube-controller-worker
    spec:
      tolerations:
        - operator: "Exists"
      containers:
      - env:
        - name: DKUBE_MOUNT_PATH
          value: /home/dkube/d3s
        - name: DKUBE_REGISTRY
          value: dkubeRegistryPath
        - name: DKUBE_REGISTRY_UNAME
          value: dkubeRegistryUname
        - name: DKUBE_REGISTRY_PASSWD
          value: dkubeRegistryPasswd
        - name: DKUBE_SERVICE_ACCOUNT
          value: dkube
        - name: RDMA_ENABLED
          value: "false"
        - name: NFS_SERVER
          value: nfsServer
        - name: NFS_BASE_PATH
          value: nfsBasePath
        - name: DKUBE_STORAGE_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: dkube-installer
              key: DKUBE_STORAGE_PROVIDER
        - name: DKUBE_APISERVER_ROLE
          value: worker
        - name: DKUBE_CLUSTER
          value: dkubeClusterType
        - name: MODEL_REGISTRY
          value: modelRegistry
        envFrom:
        - configMapRef:
            name: ceph-config
            optional: true
        image: dkubeApiServerImage
        imagePullPolicy: IfNotPresent
        name: main
        ports:
        - containerPort: 5000
          name: dkube-d3api
          protocol: TCP
        securityContext:
          procMount: Default
          runAsUser: 0
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /home/dkube/d3s
          name: store
        - mountPath: /var/run/docker.sock
          name: docker
        - mountPath: /var/log/dkube
          name: dkube-logs
        - mountPath: /etc/dkube/dkube_platform_cfg
          name: pc
      - image: dkubeDownloaderImage
        imagePullPolicy: IfNotPresent
        name: sidecar
        securityContext:
          procMount: Default
          runAsUser: 0
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      restartPolicy: Always
      serviceAccount: dkube
      serviceAccountName: dkube
      volumes:
      - name: store
        nfs:
          path: nfsBasePath/dkube
          server: nfsServer
      - name: dkube-logs
        nfs:
          path: nfsBasePath/dkube/system/logs/dkube
          server: nfsServer
      - hostPath:
          path: /var/run/docker.sock
        name: docker
      - configMap:
          name: dkube-platform-cfg
        name: pc
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: dkube-ext
    ksonnet.io/component: dkube
  name: dkube-exporter-verTag
  namespace: dkube
spec:
  selector:
    matchLabels:
      app: dkube-ext
  template:
    metadata:
      labels:
        app: dkube-ext
    spec:
      tolerations:
        - operator: "Exists"
      containers:
      - env:
        - name: MYNODENAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        image: dkubeExtImage
        imagePullPolicy: IfNotPresent
        name: main
        ports:
        - containerPort: 9401
          name: http-metrics
          protocol: TCP
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - mountPath: /usr/local/nvidia/lib64
          name: nvidia-lib
        - mountPath: /var/run/docker.sock
          name: docker
      serviceAccountName: dkube
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      imagePullSecrets:
      - name: dkubeDockerSecret
      volumes:
      - hostPath:
          path: /usr/lib64/nvidia
        name: nvidia-lib
      - hostPath:
          path: /var/run/docker.sock
        name: docker

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    k8s-app: dkube-log-collector
    ksonnet.io/component: dkube
  name: dkube-log-processor-verTag
  namespace: dkube
spec:
  selector:
    matchLabels:
      k8s-app: dkube-log-collector
  template:
    metadata:
      labels:
        k8s-app: dkube-log-collector
    spec:
      tolerations:
        - operator: "Exists"
      containers:
      - image: fluentdImage
        imagePullPolicy: IfNotPresent
        name: main
        securityContext:
          procMount: Default
          runAsUser: 0
        volumeMounts:
        - mountPath: LOG_PATH
          name: varlibdockercontainers
          readOnly: true
        - mountPath: /fluentd/etc/
          name: dkube-log-collector
          readOnly: true
        - mountPath: /var/log
          name: varlog
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: dkube
      volumes:
      - hostPath:
          path: /var/log
        name: varlog
      - configMap:
          defaultMode: 420
          name: dkube-log-collector
        name: dkube-log-collector
      - hostPath:
          path: LOG_PATH
        name: varlibdockercontainers
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-auth
    ksonnet.io/component: dkube
  name: dkube-auth-server-verTag
  namespace: dkube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dkube-auth
  template:
    metadata:
      labels:
        app: dkube-auth
      name: d3auth
      namespace: dkube
    spec:
      containers:
      - command:
        - /opt/dkube/startup
        image: dkubeAuthImage
        imagePullPolicy: IfNotPresent
        name: main
        ports:
        - containerPort: 5556
          name: dex-s
          protocol: TCP
        securityContext:
          procMount: Default
          runAsUser: 0
      - image: dkubeAuthImage
        imagePullPolicy: IfNotPresent
        name: sidecar
        command: ["bash", "-c", "sleep 30; /opt/dkube/d3"]
        env:
        - name: DKUBE_CLUSTER
          value: dkubeClusterType
        ports:
        - containerPort: 3001
          name: authn
          protocol: TCP
        volumeMounts:
        - mountPath: /var/log/dkube
          name: dkube-logs
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      serviceAccount: dkube
      serviceAccountName: dkube
      volumes:
      - name: dkube-logs
        nfs:
          path: nfsBasePath/dkube/system/logs/dkube
          server: nfsServer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    ksonnet.io/component: dkube
  name: dkube-db-server-verTag
  namespace: dkube
spec:
  selector:
    matchLabels:
      app: dkube-db-server
  template:
    metadata:
      labels:
        app: dkube-db-server
    spec:
      containers:
      - command:
        - etcd
        - --listen-client-urls=http://0.0.0.0:2379
        - --advertise-client-urls=http://0.0.0.0:2379
        - --data-dir=/var/lib/etcd
        - --force-new-cluster
        image: k8s.gcr.io/etcd-amd64:3.1.12
        imagePullPolicy: IfNotPresent
        name: main
        livenessProbe:
          exec:
            command:
            - etcdctl
            - cluster-health
          failureThreshold: 3
          initialDelaySeconds: 60
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        volumeMounts:
        - mountPath: /var/lib/etcd
          name: etcd-data
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      nodeSelector: NODE_SELECTOR
      volumes:
      - name: etcd-data
        persistentVolumeClaim:
          claimName: dkube-db-pvc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-tools
    ksonnet.io/component: dkube
  name: dkube-inf-doc-server-verTag
  namespace: dkube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dkube-tools
  template:
    metadata:
      labels:
        app: dkube-tools
    spec:
      containers:
      - image: dkubeInferenceImage
        imagePullPolicy: IfNotPresent
        name: main
      - image: dkubeDocsImage
        imagePullPolicy: IfNotPresent
        name: sidecar
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-operator-proxy
    ksonnet.io/component: dkube
  name: dkube-operator-api-proxy-verTag
  namespace: dkube
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dkube-operator-proxy
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dkube-operator-proxy
    spec:
      containers:
      - image: dfabProxyImage
        imagePullPolicy: IfNotPresent
        name: main
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      schedulerName: default-scheduler
      terminationGracePeriodSeconds: 30
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-storage-exporter
    ksonnet.io/component: dkube
  name: dkube-storage-exporter-verTag
  namespace: dkube
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: dkube-storage-exporter
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dkube-storage-exporter
    spec:
      containers:
      - env:
        - name: DKUBE_STORAGE_PATH
          value: /opt/dkube-storage
        image: storageExporterImage
        imagePullPolicy: IfNotPresent
        name: main
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /opt/dkube-storage
          name: storage
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      schedulerName: default-scheduler
      terminationGracePeriodSeconds: 30
      volumes:
      - name: storage
        nfs:
          path: nfsBasePath/
          server: nfsServer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: dkube-d3watcher
    ksonnet.io/component: dkube
  name: dkube-watcher-verTag
  namespace: dkube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dkube-d3watcher
  template:
    metadata:
      labels:
        app: dkube-d3watcher
    spec:
      containers:
      - env:
        - name: DKUBE_SERVICE_ACCOUNT
          value: dkube
        image: dkubeWatcherImage
        imagePullPolicy: IfNotPresent
        name: main
        securityContext:
          procMount: Default
          runAsUser: 0
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/log/dkube
          name: dkube-logs-host
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: dkube
      serviceAccountName: dkube
      volumes:
      - hostPath:
          path: /var/log/dkube
          type: DirectoryOrCreate
        name: dkube-logs-host
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: dkube-controller-master
    ksonnet.io/component: dkube
  annotations:
    IAM_ROLE_ANNOTATION
  name: dkube-controller-master-verTag
  namespace: dkube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dkube-controller-master
  serviceName: dkube-controller-master-headless
  template:
    metadata:
      annotations:
        IAM_ROLE_ANNOTATION
      labels:
        app: dkube-controller-master
    spec:
      containers:
      - image: dkubePlServerImage
        imagePullPolicy: IfNotPresent
        name: d3pl
        ports:
        - containerPort: 5001
          name: dkube-d3pl
          protocol: TCP
        securityContext:
          procMount: Default
          runAsUser: 0
      - image: dkubeMlFlowServerImage
        imagePullPolicy: IfNotPresent
        name: d3mlflow
        ports:
        - containerPort: 5002
          name: dkube-d3mlflow
          protocol: TCP
        securityContext:
          procMount: Default
          runAsUser: 0
        volumeMounts:
        - mountPath: /dkube
          name: store
      - env:
        - name: DKUBE_MOUNT_PATH
          value: /home/dkube/d3s
        - name: DKUBE_REGISTRY
          value: dkubeRegistryPath
        - name: DKUBE_REGISTRY_UNAME
          value: dkubeRegistryUname
        - name: DKUBE_REGISTRY_PASSWD
          value: dkubeRegistryPasswd
        - name: DKUBE_SERVICE_ACCOUNT
          value: dkube
        - name: RDMA_ENABLED
          value: "false"
        - name: NFS_SERVER
          value: nfsServer
        - name: NFS_BASE_PATH
          value: nfsBasePath
        - name: DKUBE_APISERVER_ROLE
          value: master
        - name: DKUBE_STORAGE_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: dkube-installer
              key: DKUBE_STORAGE_PROVIDER
        - name: DKUBE_CLUSTER
          value: dkubeClusterType
        - name: MODEL_REGISTRY
          value: modelRegistry
        envFrom:
        - configMapRef:
            name: ceph-config
            optional: true
        image: dkubeApiServerImage
        imagePullPolicy: IfNotPresent
        name: main
        ports:
        - containerPort: 5000
          name: dkube-d3api
          protocol: TCP
        securityContext:
          procMount: Default
          runAsUser: 0
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /home/dkube/d3s
          name: store
        - mountPath: /var/run/docker.sock
          name: docker
        - mountPath: /var/log/dkube
          name: dkube-logs
        - mountPath: /etc/dkube/dkube_platform_cfg
          name: pc
      dnsConfig:
        options:
        - name: single-request-reopen
        - name: timeout
          value: "30"
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: dkubeDockerSecret
      nodeSelector: NODE_SELECTOR
      restartPolicy: Always
      serviceAccount: dkube
      serviceAccountName: dkube
      volumes:
      - name: store
        nfs:
          path: nfsBasePath/dkube
          server: nfsServer
      - name: dkube-logs
        nfs:
          path: nfsBasePath/dkube/system/logs/dkube
          server: nfsServer
      - hostPath:
          path: /var/run/docker.sock
        name: docker
      - configMap:
          name: dkube-platform-cfg
        name: pc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    dkube: ingressgateway
  name: dkube-ingressgateway-verTag
  namespace: dkube
spec:
  selector:
    matchLabels:
      dkube: ingressgateway
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
      labels:
        dkube: ingressgateway
        service: dkube-proxy
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - ppc64le
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - s390x
            weight: 2
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
                - ppc64le
                - s390x
      containers:
      - args:
        - proxy
        - router
        - --domain
        - $(POD_NAMESPACE).svc.cluster.local
        - --log_output_level=default:info
        - --drainDuration
        - 45s
        - --parentShutdownDuration
        - 1m0s
        - --connectTimeout
        - 10s
        - --serviceCluster
        - dkube-proxy
        - --zipkinAddress
        - zipkin.istio-system:9411
        - --proxyAdminPort
        - "15000"
        - --statusPort
        - "15020"
        - --controlPlaneAuthPolicy
        - NONE
        - --discoveryAddress
        - istio-pilot.istio-system:15010
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.hostIP
        - name: ISTIO_META_POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: ISTIO_META_CONFIG_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: ISTIO_META_ROUTER_MODE
          value: sni-dnat
        image: docker.io/istio/proxyv2:1.1.6
        imagePullPolicy: IfNotPresent
        name: istio-proxy
        ports:
        - containerPort: 443
          protocol: TCP
        readinessProbe:
          failureThreshold: 30
          httpGet:
            path: /healthz/ready
            port: 15020
            scheme: HTTP
          initialDelaySeconds: 1
          periodSeconds: 2
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/certs
          name: istio-certs
          readOnly: true
        - mountPath: /etc/istio/ingressgateway-certs
          name: ingressgateway-certs
          readOnly: true
        - mountPath: /etc/istio/ingressgateway-ca-certs
          name: ingressgateway-ca-certs
          readOnly: true
      serviceAccountName: dkube
      volumes:
      - name: istio-certs
        secret:
          defaultMode: 420
          optional: true
          secretName: istio.istio-ingressgateway-service-account
      - name: ingressgateway-certs
        secret:
          defaultMode: 420
          secretName: dkube-certificate-secret
      - name: ingressgateway-ca-certs
        secret:
          defaultMode: 420
          optional: true
          secretName: istio-ingressgateway-ca-certs
